<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>你的理想人生 -- 性格測試</title>
  <style>
    :root{
      --bg:#f6fbff; --card:#ffffff; --accent:#16a34a; --muted:#6b7280;
      --lego-1:#60a5fa; --lego-2:#f472b6; --lego-3:#f59e0b; --lego-4:#10b981;
      font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --base-font-size:15px; --desktop-max-width:980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: linear-gradient(180deg,#f0f9f4 0%, #fff 60%);
      display:flex; align-items:flex-start; justify-content:center; padding:12px;
      color:#0f172a; font-size:var(--base-font-size); line-height:1.45;
    }

    .shell{width:100%;max-width:var(--desktop-max-width);background:var(--card);border-radius:12px;box-shadow:0 14px 40px rgba(6,8,23,0.08);overflow:hidden;display:flex}
    .main{flex:1 1 640px;padding:20px;min-width:0}
    header h1{margin:0 0 6px 0;font-size:18px}
    header p{margin:0 0 14px 0;color:var(--muted);font-size:13px}
    .step{display:none;animation:fadeIn .25s ease}
    .step.active{display:block}
    .card{background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,1));border-radius:10px;padding:14px;margin-bottom:12px;box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);}

    .question{font-weight:700;margin-bottom:10px;font-size:15px}
    .choices{display:flex;flex-direction:column;gap:10px; position:relative; z-index:2}
    .choice-btn{width:100%;text-align:left;padding:11px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:white;cursor:pointer;font-size:15px;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;}
    .choice-btn:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(13,38,89,0.05)}
    .choice-btn.selected{border-color:var(--accent);box-shadow:0 8px 22px rgba(22,163,74,0.12);outline:3px solid rgba(22,163,74,0.06);}

    .nav{display:flex;gap:10px;margin-top:8px;justify-content:space-between;align-items:center}
    .nav .left{color:var(--muted); font-size:13px}
    .nav .right{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700;font-size:14px}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(15,23,42,0.06)}
    .btn.primary{background:var(--accent);color:white;box-shadow:0 8px 20px rgba(22,163,74,0.16)}
    .btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;transform:none}

    .side{width:320px;background:linear-gradient(180deg,#f7fffb, #f3fff6);padding:16px;border-left:1px solid rgba(15,23,42,0.03);display:flex;flex-direction:column;gap:10px;min-width:180px}
    .progress{height:10px;background:rgba(15,23,42,0.06);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#059669);transition:width .28s ease}
    .meta h3{margin:0;font-size:15px}
    .meta p{margin:6px 0 0 0;color:var(--muted);font-size:13px}
    .result{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(12,15,24,0.04);display:none}
    .result.visible{display:block}

    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    /* overlay (starts hidden and non-interactive) */
    .build-overlay{
      position:fixed; left:0; top:0; right:0; bottom:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(10,12,20,0.28); z-index:1200;
      pointer-events:none; opacity:0; transition:opacity .18s ease;
    }
    .build-overlay.show{
      pointer-events:auto; opacity:1;
    }
    .build-canvas{ width:420px; max-width:92vw; height:260px; background:linear-gradient(180deg,#fff,#f7fff7); border-radius:12px; box-shadow:0 24px 60px rgba(6,8,23,0.18); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
    .build-stage{ width:320px; height:200px; position:relative; }

    .brick{ transition:transform .36s cubic-bezier(.2,.9,.2,1), opacity .2s linear; transform-origin:center; }
    .brick-plate{ filter: drop-shadow(0 6px 8px rgba(6,8,23,0.12)); }

    .lego-row{display:flex;align-items:center;gap:12px}
    .title-top{font-size:18px;font-weight:800;margin:0 0 6px 0}
    .lego-title{font-weight:900;color:var(--accent);font-size:46px;line-height:1;letter-spacing:2px;margin:6px 0 10px 0;text-align:left}
    .lego-animal-wrap{width:96px;height:72px;display:flex;align-items:center;justify-content:center}
    .lego-animal-svg{width:96px;height:72px}
    .result-footer{margin-top:12px;padding:10px;border-radius:6px;border:1px solid rgba(15,23,42,0.04);background:#ffffff;color:var(--muted);font-size:14px;line-height:1.45;max-height:220px;overflow:auto}

    @media (max-width:480px){ .lego-title{font-size:36px} .build-canvas{width:92vw;height:200px} }

    .share-row{display:flex;gap:8px;align-items:center;margin-top:12px}
    .share-btn,.copy-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .share-btn{background:linear-gradient(90deg,var(--accent),#059669);color:#fff;border:0}
    .copy-btn{background:#fff;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}
  </style>
</head>
<body>
  <div class="shell" role="application" aria-label="你的理想人生 -- 性格測試">
    <main class="main" aria-live="polite">

      <header>
        <h1>性格測試</h1>
        <p>五個章節的簡短測驗。答案沒有對錯，請誠實作答以得到更貼近你的解析。</p>
      </header>

      <section id="s1" class="step active" aria-labelledby="s1-title">
        <div class="card">
          <h2 id="s1-title" style="margin-top:0">歡迎</h2>
          <p>歡迎參與本次的性格測試。透過回答問題可知道你對於人生的看法。</p>
        </div>
        <div class="nav" aria-hidden="false">
          <div class="left">第 1 / 5 章節</div>
          <div class="right">
            <button class="btn ghost" id="reset-1" disabled aria-hidden="true">重置</button>
            <button class="btn primary" id="to-2">開始</button>
          </div>
        </div>
      </section>

      <section id="s2" class="step" aria-labelledby="s2-title">
        <div class="card">
          <div class="question" id="s2-title">過去篇：如果你能回到過去，你會想：</div>
          <div class="choices" role="radiogroup" aria-labelledby="s2-title">
            <button class="choice-btn" data-step="2" data-value="1" aria-checked="false" role="radio">1 -- 再次感受最快樂的一天</button>
            <button class="choice-btn" data-step="2" data-value="2" aria-checked="false" role="radio">2 -- 改變最後悔的一天</button>
            <button class="choice-btn" data-step="2" data-value="3" aria-checked="false" role="radio">3 -- 只是觀察當時的自己，不改變</button>
            <button class="choice-btn" data-step="2" data-value="4" aria-checked="false" role="radio">4 -- 與當時重要的人說出當時沒說的話</button>
          </div>
        </div>
        <div class="nav">
          <div class="left">第 2 / 5 章節</div>
          <div class="right">
            <button class="btn ghost" id="back-2">上一步</button>
            <button class="btn primary" id="to-3" disabled>下一步</button>
          </div>
        </div>
      </section>

      <section id="s3" class="step" aria-labelledby="s3-title">
        <div class="card">
          <div class="question" id="s3-title">現在篇：你有一天的假期，你想如何渡過？</div>
          <div class="choices" role="radiogroup" aria-labelledby="s3-title">
            <button class="choice-btn" data-step="3" data-value="1" aria-checked="false" role="radio">1 -- 獨自一人休閒地休息</button>
            <button class="choice-btn" data-step="3" data-value="2" aria-checked="false" role="radio">2 -- 與家人朋友聚會</button>
            <button class="choice-btn" data-step="3" data-value="3" aria-checked="false" role="radio">3 -- 外出一日小旅行</button>
            <button class="choice-btn" data-step="3" data-value="4" aria-checked="false" role="radio">4 -- 參加興趣課程或工作坊</button>
          </div>
        </div>
        <div class="nav">
          <div class="left">第 3 / 5 章節</div>
          <div class="right">
            <button class="btn ghost" id="back-3">上一步</button>
            <button class="btn primary" id="to-4" disabled>下一步</button>
          </div>
        </div>
      </section>

      <section id="s4" class="step" aria-labelledby="s4-title">
        <div class="card">
          <div class="question" id="s4-title">未來篇：您希望你未來的生活是？</div>
          <div class="choices" role="radiogroup" aria-labelledby="s4-title">
            <button class="choice-btn" data-step="4" data-value="1" aria-checked="false" role="radio">1 -- 富有及自由地環遊世界</button>
            <button class="choice-btn" data-step="4" data-value="2" aria-checked="false" role="radio">2 -- 平淡地與最親的人生活</button>
            <button class="choice-btn" data-step="4" data-value="3" aria-checked="false" role="radio">3 -- 專注事業或專業成就</button>
            <button class="choice-btn" data-step="4" data-value="4" aria-checked="false" role="radio">4 -- 過更有意義的志願或社群貢獻</button>
          </div>
        </div>
        <div class="nav">
          <div class="left">第 4 / 5 章節</div>
          <div class="right">
            <button class="btn ghost" id="back-4">上一步</button>
            <button class="btn primary" id="to-5" disabled>下一步</button>
          </div>
        </div>
      </section>

      <section id="s5" class="step" aria-labelledby="s5-title">
        <div class="card">
          <h2 class="title-top">你的性格是...</h2>

          <div class="lego-row">
            <div>
              <div class="lego-title" aria-hidden="true">LEGO</div>
            </div>
            <div class="lego-animal-wrap" id="lego-animal-wrap" aria-hidden="true"></div>
          </div>

          <div id="final-content"></div>

          <div id="after-conclusion" style="margin-top:10px;color:#0f172a;font-size:14px;line-height:1.6">
            你的人生是一幅獨一無二的作品，透過砌LEGO自癒工作坊，發揮你無窮的創意和突破框框，了解和反思自己內心的狀況、面對過去或現在的困境，同覓出路和重現盼望！
          </div>

          <div class="result-footer" id="result-footer" tabindex="0" aria-label="活動資訊（可捲動）">
            <p style="margin:0 0 8px 0;font-weight:700;">
              LEGO 自癒工作坊<br>日期：9月6日<br>時間：4:30pm - 6:00pm<br>地點：播道書院跳舞室<br>
            </p>
            <div id="footer-abstract" style="margin-top:8px;color:#0f172a;font-size:14px"></div>
          </div>

          <div class="share-row" aria-label="分享測驗">
            <button class="share-btn" id="share-btn" type="button" aria-label="分享測驗">分享測驗</button>
            <button class="copy-btn" id="copy-link" type="button" aria-label="複製連結">複製連結</button>
          </div>
        </div>

        <div class="nav">
          <div class="left">第 5 / 5 章節</div>
          <div class="right">
            <button class="btn ghost" id="back-5">上一步</button>
            <button class="btn primary" id="restart">重新開始</button>
          </div>
        </div>
      </section>

    </main>

    <aside class="side" aria-hidden="false">
      <div>
        <strong>進度</strong>
        <div class="progress" aria-hidden="true" style="margin-top:8px"><i id="bar"></i></div>
      </div>

      <div class="meta">
        <h3 id="meta-title">尚未開始</h3>
        <p id="meta-desc">請從第 1 章開始。每個章節選一項後，可前往下一章節。</p>
      </div>

      <div class="result" id="side-result" aria-live="polite">
        <h4 id="side-title">你的摘要</h4>
        <p id="side-text">完成測驗後，這裡會顯示你的結果摘要。</p>
      </div>
    </aside>
  </div>

  <!-- overlay (single declaration, starts hidden) -->
  <div class="build-overlay" id="build-overlay" role="dialog" aria-hidden="true">
    <div class="build-canvas" id="build-canvas" aria-hidden="true">
      <div class="build-stage" id="build-stage" aria-hidden="true"></div>
    </div>
  </div>

  <script>
    (function(){
      // state
      const total = 5;
      const answers = {2:null,3:null,4:null};
      let current = 1;

      // elements (cached)
      const overlay = document.getElementById('build-overlay');
      const stage = document.getElementById('build-stage');
      const to2 = document.getElementById('to-2');
      const to3 = document.getElementById('to-3');
      const to4 = document.getElementById('to-4');
      const to5 = document.getElementById('to-5');

      function show(step){
        for(let i=1;i<=5;i++){
          const el = document.getElementById('s'+i);
          if(!el) continue;
          el.classList.toggle('active', i===step);
        }
        current = step;
        updateProgress();
        updateMeta();
        // restore choices visibility when returning to earlier sections
        if(step >=2 && step <=4){
          document.querySelectorAll('#s'+step+' .choices').forEach(el=> el.style.display = '');
        }
      }

      function updateProgress(){
        const bar = document.getElementById('bar');
        const pct = Math.round((current-1)/(total-1)*100);
        bar.style.width = pct + '%';
      }

      function updateMeta(){
        const title = document.getElementById('meta-title');
        const filled = Object.values(answers).filter(v=>v!==null).length;
        title.textContent = `已回答 ${filled} / 3（選擇題）`;
        document.getElementById('meta-desc').textContent = '第 ' + current + ' 章節';
        document.getElementById('side-result').classList.toggle('visible', current===5);
      }

      // navigation wiring
      to2.addEventListener('click', ()=> show(2));
      document.getElementById('back-2').addEventListener('click', ()=> show(1));
      document.getElementById('back-3').addEventListener('click', ()=> show(2));
      document.getElementById('back-4').addEventListener('click', ()=> show(3));
      document.getElementById('back-5').addEventListener('click', ()=> show(4));
      document.getElementById('restart').addEventListener('click', resetAll);

      to3.addEventListener('click', ()=> show(3));
      to4.addEventListener('click', ()=> show(4));
      to5 && to5.addEventListener('click', ()=> {
        // ensure overlay is above and interactive during animation
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
        playBuildAnimation().then(()=> {
          overlay.classList.remove('show');
          overlay.setAttribute('aria-hidden','true');
          renderFinal();
          show(5);
        });
      });

      function disableNext(step){ if(step===2) to3.disabled=true; if(step===3) to4.disabled=true; if(step===4) to5.disabled=true; }
      function enableNext(step){ if(step===2) to3.disabled=false; if(step===3) to4.disabled=false; if(step===4) to5.disabled=false; }
      try{ disableNext(2); disableNext(3); disableNext(4); }catch(e){}

      // ensure overlay doesn't block clicks when hidden
      overlay.style.pointerEvents = 'none';

      // choice handling
      document.querySelectorAll('.choice-btn').forEach(btn=>{
        // ensure pointer-events enabled
        btn.style.pointerEvents = 'auto';
        btn.addEventListener('click', function(){
          const step = Number(this.dataset.step);
          const val = this.dataset.value;
          document.querySelectorAll('.choice-btn[data-step="'+step+'"]').forEach(b=>{
            b.classList.toggle('selected', b===this);
            b.setAttribute('aria-checked', b===this ? 'true' : 'false');
          });
          if(step>=2 && step<=4){
            answers[step] = val;
            enableNext(step);
            updateMeta();
          }
        });
      });

      // content (summaries + labels)
      const merged = {
        '1':'你偏好靜心獨處以恢復能量；建議每週安排一次30至40分鐘無手機靜心或寫日記，觀察情緒變化並溫柔對待自己，給自己休息的許可與練習。',
        '2':'你從人際連結獲得支持與力量；建議本週主動邀一位親友共度時光，分享近況並用心傾聽，透過互動加深情感與彼此支持。',
        '3':'你渴望探索與學習，喜歡新鮮體驗；建議規劃短期小旅行或報名體驗課，透過行動開拓視野並把好奇心轉為實際學習。',
        '4':'你追求意義與影響，喜歡長期投入；建議加入志願團體或擔任短期導師，從小規模貢獻開始建立持續的回饋與成長路徑。'
      };
      const labels = {'1':'內向 / 沉澱','2':'關係 / 連結','3':'探索 / 冒險','4':'貢獻 / 成長'};

      function computeCountsAndTops(){
        const counts = {'1':0,'2':0,'3':0,'4':0};
        [2,3,4].forEach(k=>{ const v=answers[k]; if(v && counts.hasOwnProperty(v)) counts[v]++; });
        let max=0; Object.values(counts).forEach(n=>{ if(n>max) max=n; });
        const tops = max===0?[]:Object.keys(counts).filter(k=>counts[k]===max).slice(0,2);
        return {counts,tops};
      }

      function renderFinal(){
        const {counts,tops} = computeCountsAndTops();
        let text='';
        if(tops.length===0) text='你尚未完成測驗，請返回並回答問題以獲得個人化建議。';
        else if(tops.length===1) text = merged[tops[0]];
        else { text = merged[tops[0]].replace(/。$/,'') + '；' + merged[tops[1]]; if(text.length>220) text = text.slice(0,216)+'…'; }
        document.getElementById('final-content').innerHTML = `<p style="margin-top:8px;font-size:15px;line-height:1.6;color:#0f172a">${text}</p>`;

        const footerAbstract = document.getElementById('footer-abstract');
        if(Object.values(counts).every(n=>n===0)){
          footerAbstract.innerHTML = '<em style="color:var(--muted)">尚無摘要：請完成測驗以顯示摘要。</em>';
        } else {
          const countLine = `選項計數 — 1:${counts['1']}　2:${counts['2']}　3:${counts['3']}　4:${counts['4']}`;
          const primary = tops.length>0 ? tops.map(k=>labels[k]).join(' / ') : '無';
          const primaryLine = `<strong>主要類型：</strong>${primary}`;
          footerAbstract.innerHTML = `<div style="margin-bottom:6px;color:var(--muted);font-size:13px">${countLine}</div><div style="font-size:14px;color:#0f172a">${primaryLine}</div>`;
        }

        // insert final animal
        const wrap = document.getElementById('lego-animal-wrap');
        wrap.innerHTML = '';
        const animal = buildAnimalSVG(tops[0]||null,tops[1]||null);
        if(animal) wrap.appendChild(animal);

        // hide choices everywhere to keep result clean
        document.querySelectorAll('.choices').forEach(el=>el.style.display='none');
      }

      function resetAll(){
        for(const k in answers) answers[k]=null;
        document.querySelectorAll('.choice-btn.selected').forEach(b=>b.classList.remove('selected'));
        disableNext(2); disableNext(3); disableNext(4);
        document.getElementById('meta-title').textContent = '尚未開始';
        document.getElementById('meta-desc').textContent = '請從第 1 章開始。';
        document.getElementById('final-content').innerHTML = '';
        document.getElementById('footer-abstract').innerHTML = '';
        document.getElementById('lego-animal-wrap').innerHTML = '';
        show(1);
      }

      // --- build animation (overlay) ---
      const palette = {
        '1':['#cfe0ff','#94b3ff','#60a5fa'],
        '2':['#ffe6f0','#f9a8d4','#f472b6'],
        '3':['#fff7cc','#fcd34d','#f59e0b'],
        '4':['#dfffe9','#6ee7b7','#34d399']
      };

      function playBuildAnimation(){
        const {counts,tops} = computeCountsAndTops();
        const primary = tops[0]||null;
        const secondary = tops[1]||null;
        if(!primary) return Promise.resolve();

        // prepare stage
        stage.innerHTML = '';
        overlay.classList.add('show');
        overlay.style.pointerEvents = 'auto'; // enable blocking interactions during animation
        overlay.setAttribute('aria-hidden','false');

        const bricks = createBricksFor(primary,secondary);
        bricks.forEach((b,i)=>{
          stage.appendChild(b.g);
          setTimeout(()=> {
            b.g.style.transform = `translate(${b.to.x}px, ${b.to.y}px) rotate(${b.toRot}deg)`;
            b.g.style.opacity = '1';
          }, 120 + i*140);
        });

        const totalTime = 120 + bricks.length*140 + 520;
        return new Promise(resolve=>{
          setTimeout(()=> {
            // end animation
            overlay.classList.remove('show');
            overlay.style.pointerEvents = 'none';
            overlay.setAttribute('aria-hidden','true');
            setTimeout(()=>{ stage.innerHTML=''; resolve(); }, 260);
          }, totalTime);
        });
      }

      // brick creation (same as previous, compacted)
      function makeBrick(w,h,color,studCount){
        const ns='http://www.w3.org/2000/svg';
        const g = document.createElementNS(ns,'svg');
        g.setAttribute('width', w); g.setAttribute('height', h); g.setAttribute('viewBox', `0 0 ${w} ${h}`);
        g.setAttribute('class','brick brick-plate');
        g.style.position='absolute';
        g.style.left = (Math.random()*260 - 120) + 'px';
        g.style.top = (Math.random()*160 - 80) + 'px';
        g.style.opacity = '0';
        g.style.transform = 'translate(0,0) rotate(0deg)';

        const defs = document.createElementNS(ns,'defs');
        const grad = document.createElementNS(ns,'linearGradient');
        const gid = 'g'+Math.random().toString(36).slice(2,9);
        grad.setAttribute('id', gid); grad.setAttribute('x1','0'); grad.setAttribute('y1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
        const stop1 = document.createElementNS(ns,'stop'); stop1.setAttribute('offset','0'); stop1.setAttribute('stop-color', lightenColor(color,0.12));
        const stop2 = document.createElementNS(ns,'stop'); stop2.setAttribute('offset','1'); stop2.setAttribute('stop-color', darkenColor(color,0.06));
        grad.appendChild(stop1); grad.appendChild(stop2); defs.appendChild(grad); g.appendChild(defs);

        const rect = document.createElementNS(ns,'rect');
        rect.setAttribute('x','0'); rect.setAttribute('y','0'); rect.setAttribute('width',w); rect.setAttribute('height',h); rect.setAttribute('rx',Math.max(3,Math.min(6,Math.floor(h/6))));
        rect.setAttribute('fill', `url(#${gid})`); rect.setAttribute('stroke', shade(color,-0.08)); rect.setAttribute('stroke-width','1'); g.appendChild(rect);

        const studR = Math.min(6, Math.floor(Math.min(w,h)/6));
        const gap = (w - studR*2) / (studCount+1);
        for(let i=0;i<studCount;i++){
          const cx = Math.round(gap*(i+1) + studR*(i) + studR);
          const cy = studR + 3;
          const sOuter = document.createElementNS(ns,'circle'); sOuter.setAttribute('cx',cx); sOuter.setAttribute('cy',cy); sOuter.setAttribute('r',studR); sOuter.setAttribute('fill', shade(color,0.12)); sOuter.setAttribute('opacity','0.95'); g.appendChild(sOuter);
          const sTop = document.createElementNS(ns,'circle'); sTop.setAttribute('cx',cx-0.6); sTop.setAttribute('cy',cy-1); sTop.setAttribute('r',studR*0.6); sTop.setAttribute('fill','#ffffff'); sTop.setAttribute('opacity','0.28'); g.appendChild(sTop);
        }
        return g;
      }

      function createBricksFor(primary,secondary){
        const colors = palette[primary] || ['#ddd','#bbb','#999'];
        const accent = (palette[secondary] && palette[secondary][1]) || null;
        const specs = [
          {w:78,h:36,color:colors[1],stud:3, final:{x:40,y:64}},
          {w:46,h:30,color:colors[0],stud:2, final:{x:100,y:40}},
          {w:30,h:22,color:colors[2],stud:1, final:{x:14,y:44}},
          {w:22,h:18,color:colors[2],stud:1, final:{x:48,y:108}},
          {w:22,h:18,color:colors[2],stud:1, final:{x:76,y:108}},
          {w:12,h:10,color:accent||colors[0],stud:1, final:{x:116,y:34}}
        ];
        const stageW = 320, stageH=200; const cx = stageW/2, cy = stageH/2 - 6;
        return specs.map(s=>{
          const g = makeBrick(s.w,s.h,s.color,s.stud);
          const to = { x: cx + s.final.x - s.w/2 - 160, y: cy + s.final.y - s.h/2 - 90 };
          const toRot = (Math.random()*14 - 7);
          return { g, to, toRot };
        });
      }

      // color helpers
      function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
      function hexToRgb(hex){ hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(h=>h+h).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return {r,g,b}; }
      function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }
      function lightenColor(hex, amt){ const c=hexToRgb(hex); const r=clamp(Math.round(c.r + 255*amt),0,255), g=clamp(Math.round(c.g + 255*amt),0,255), b=clamp(Math.round(c.b + 255*amt),0,255); return rgbToHex(r,g,b); }
      function darkenColor(hex, amt){ const c=hexToRgb(hex); const r=clamp(Math.round(c.r*(1-amt)),0,255), g=clamp(Math.round(c.g*(1-amt)),0,255), b=clamp(Math.round(c.b*(1-amt)),0,255); return rgbToHex(r,g,b); }
      function shade(hex, amt){ if(amt>0) return lightenColor(hex, amt); else return darkenColor(hex, -amt); }

      // final animal SVG builder
      function buildAnimalSVG(primary,secondary){
        if(!primary) return null;
        const ns='http://www.w3.org/2000/svg';
        const svg = document.createElementNS(ns,'svg');
        svg.setAttribute('viewBox','0 0 96 72'); svg.setAttribute('class','lego-animal-svg'); svg.setAttribute('width','96'); svg.setAttribute('height','72');
        const colors = palette[primary];
        svg.appendChild(makeSimpleBrickRect(22,26,60,36, colors[1]));
        svg.appendChild(makeSimpleBrickRect(62,18,26,22, colors[0]));
        svg.appendChild(makeSimpleBrickRect(8,22,8,28, colors[2]));
        svg.appendChild(makeSimpleBrickRect(28,52,10,12, colors[2]));
        svg.appendChild(makeSimpleBrickRect(42,52,10,12, colors[2]));
        const eye = document.createElementNS(ns,'circle'); eye.setAttribute('cx','72'); eye.setAttribute('cy','34'); eye.setAttribute('r','3.2'); eye.setAttribute('fill', (palette[secondary] && palette[secondary][1]) || '#ffffff'); svg.appendChild(eye);
        return svg;
      }
      function makeSimpleBrickRect(x,y,w,h,color){
        const ns='http://www.w3.org/2000/svg'; const g = document.createElementNS(ns,'g');
        const rect = document.createElementNS(ns,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',w); rect.setAttribute('height',h); rect.setAttribute('rx',6);
        rect.setAttribute('fill', color); rect.setAttribute('stroke', shade(color,-0.08)); rect.setAttribute('stroke-width','1'); g.appendChild(rect);
        const studR = Math.min(5, Math.floor(Math.min(w,h)/8)); const positions = Math.max(1, Math.floor(w / (studR*3))); const gap = (w - positions*studR*2) / (positions+1);
        for(let i=0;i<positions;i++){ const cx = x + gap*(i+1) + studR*(2*i) + studR; const cy = y + studR + 4;
          const s = document.createElementNS(ns,'circle'); s.setAttribute('cx',cx); s.setAttribute('cy',cy); s.setAttribute('r',studR); s.setAttribute('fill', shade(color,0.12)); g.appendChild(s);
          const sTop = document.createElementNS(ns,'circle'); sTop.setAttribute('cx',cx-0.5); sTop.setAttribute('cy',cy-1); sTop.setAttribute('r', studR*0.5); sTop.setAttribute('fill','#fff'); sTop.setAttribute('opacity','0.28'); g.appendChild(sTop);
        }
        return g;
      }

      // share & copy
      const shareBtn = document.getElementById('share-btn');
      const copyBtn = document.getElementById('copy-link');
      function getSharePayload(){ const url = window.location.href; const text = encodeURIComponent('我剛完成「你的理想人生」的性格測試！一起試試看： ' + url); return {url,text}; }
      if(shareBtn){ shareBtn.addEventListener('click', async ()=>{ const payload=getSharePayload(); if(navigator.share){ try{ await navigator.share({title:'你的理想人生 -- 性格測試', text: decodeURIComponent(payload.text), url: payload.url}); }catch(e){ copyToClipboard(payload.url); alert('分享未完成，已複製連結'); } } else { window.open('https://twitter.com/intent/tweet?text='+payload.text,'_blank'); } }); }
      if(copyBtn){ copyBtn.addEventListener('click', ()=>{ copyToClipboard(getSharePayload().url); copyBtn.textContent='已複製'; setTimeout(()=>copyBtn.textContent='複製連結',2000); }); }
      function copyToClipboard(t){ if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(t); const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }

      // initial state
      updateProgress(); updateMeta();

      // accessibility: keyboard selection
      document.addEventListener('keydown', function(e){
        const active = document.activeElement;
        if(active && active.classList && active.classList.contains('choice-btn')){
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            active.click();
          }
        }
      });

    })();
  </script>
</body>
</html>
